\documentclass[a4paper,twoside, justified,marginals=raggedright]{tufte-handout}


\usepackage[utf8]{inputenc}
\usepackage{graphicx} % allow embedded images
  \setkeys{Gin}{width=\linewidth,totalheight=\textheight,keepaspectratio}
  \graphicspath{{graphics/}} % set of paths to search for images
\usepackage{amsmath}  % extended mathematics
\usepackage{amssymb}  % more math symbols
\usepackage{booktabs} % book-quality tables
\usepackage{units}    % non-stacked fractions and better unit spacing
\usepackage{multicol} % multiple column layout facilities
\usepackage{fancyvrb} % extended verbatim environments
  \fvset{fontsize=\normalsize}% default font size for fancy-verbatim environments
\usepackage{pgfplots}

\usepackage{lipsum}


% custom package list

 \usepackage{gensymb} %°C
 \geometry{bindingoffset=0.2in}
 %\usepackage{showframe}

% to see the margins and page width
% \geometry{showframe}

% Write packages versions in the log
% \listfiles

% Commands use through the document
 \newcommand{\auth}{Clément Viguier}
 \newcommand{\model}{\textit{\textbf{MountGrass }}}
 \newcommand{\tlte}{- MountGrass -\\An agent-based model for the exploration of mountain grassland community dynamics}
 \newcommand{\tltesmall}{MountGrass - Model description \date}
 
 \newcommand{\version}{\texttt{MountGrass2.0}}

 \newcommand{\gl}{\hspace{0.6cm}\textbf } %A revoir


% Commands use to make the title page and page headers
\title{\tlte}
\author{\auth}


% Include documents for graphical aspects
% Color
%\input{../latex_settings/colors}
% Graph settings
\input{../latex_settings/graph_settings}

\input{parameters}

\begin{document}

 \pgfmathsetmacro{\paralpha}{2.9662}
\maketitle
\begin{fullwidth}
\begin{abstract} \paralpha
\noindent
This document is a detailed description of the \model model. This description is based on the ODD protocol of Grimm et al.. The model is inspired by multiple other forest and grassland models (for grassland models see particularly Taubert and Lohier) but differentiates it self from these models by its incorporation of phenotypic plasticity in a generalizing framework of plant functioning. This allows it to be used to explore the dynamics of rich grass communities and the impact of the phenotypic plasticity on plant interactions. The general approach and the practical details are further detailed in this document.
\end{abstract}
\end{fullwidth}



\section{Model overview}

\subsection{Model purpose}

The development of \model is motivated by the need for a flexible tool to explore the complex dynamics of mountain grassland communities, in the context of global change. This tool should, by a better understanding of community dynamics and representation of plant strategies and interaction, also help in the assessment of ecosystem services in new conditions. We believe that to capture the dynamic of such communities, we need to understand and represent first the individual response of plants  to fluctuating levels of resources, and the impact of plants on the resources. Individual responses and relative impact should follow general rules of plant physiology but also integrates specific behaviour based on the species resource use strategy and individual characteristics. Therefore the model should allow to follow distinct individuals from different groups (e.g. species) in a spatially explicit environment where they compete for resources.\\
\indent Moreover, since we focus on the community levels, coexistence mechanisms are important and we should include a certain number of these if we want to maintain diversity to observed levels. These mechanisms include: multiple resources competition (water and light), spatial and temporal heterogeneity of resource levels, strategic trade-of between species, perturbation mechanisms (frost, management), link  to meta-population, etc...\\
\indent The model is built to try to satisfy conditions to reproduce and explore mountain grassland community dynamics. In the current version of the model (\version), a generalist approach has been privileged, and focus on some coexistence maintenance mechanisms and integration of phenotypic plasticity framework. In this state the model has to be seen as a toy model with good generalisation potential. The link between to ecosystem services are not included, but we can easily imagine to compute them from the community trait distribution. All processes and mechanism are detailed below.


\subsection{State variables}

\paragraph{Scales} In mountain grasslands individuals (tillers) generally do not growth big and interact only with close neighbours and form little patches. And thus it is possible to represent rich community at a fairly small scale ($\approx$ dm or m), but the spatial resolution should be relatively fine ($\approx$ cm) to capture inter-individual interactions. Because the model is intended to explore climate change impact on mountain grasslands, it can runs on multiple growth seasons separated by snow covered periods, but must also integrates the intra-seasonal variations at daily scale. Mountain weather (mostly temperature) is known for its large hourly variations, it would however require too much computational power to consider such variations. In addition  to this argument, we believe that even-though  they imply physiological flexibility and specific strategies for plants experiencing these conditions, they will not have a huge impact on overall community dynamics changes caused by the climate change. That why hourly variations will not be considered, and physiological processes are estimated at the daily time scale.

\paragraph{Plants} The plants are described in the model by numerous state variables. These variables are detailed in table \ref{table:state_var_plant}. The best way to understand how plant are represented is to imagine two homogeneous cylinders on top of each others, the shoot cylinder varying in radius and height representing the light acquisition (and shading) zone, and the root cylinder varying only in diameter (because of shallow soil in mountain ecosystems) representing the water acquisition zone. These cylinders are centered on a grid cell of the torus simulation plan.\\
\indent In addition to classic variables (age, position, height, diameter, shoot and root biomasses) the plants are described by traits, some are species specific (thickness) or non-specific (root section), others are variable (SLA, SRL) and depend on particular traits that are specific to this model: the \textbf{ratio between active tissue and structural tissue} (in shoot and root) (variables $\frac{act}{str}_{ag}$ and $\frac{act}{str}_{bg}$ in table \ref{table:state_var_plant}). This couple of traits come from the evidences that numerous trade-of observed in leaves can be explained (at least partially) by this allocation trade-of between active tissue producing organic matter, but increasing respiration, and structural tissue that increase tissue lifespan.

%TAble of plant state variables
\begin{table*}
\caption{State variables of individual plants} 
\label{table:state_var_plant}
%\begin{center}%
\begin{tabular}{l|l|c}
Variable & Description & Unit \\ 
\hline 
x & x position on the grid & cells \\
y & y position on the grid & cells \\
age & age & days \\
sp & species & - \\
$BM_{ag}$ & above-ground biomass & g \\
$BM_{ag_sen}$ & senescent above-ground biomass & g \\
$SLA_{sen}$ & senescent above-ground biomass & $cm^{2}.g^{-1}$ \\
$BM_{bg}$ & below-ground biomass & g \\
stem & stem biomass & g \\
$\frac{act}{str}_{ag}$ & above-ground active on structural biomass ratio & g/g \\
$\frac{act}{str}_{bg}$ & below-ground active on structural biomass ratio & g/g \\
h & height & cm \\
r & shoot radius & cm \\
r\_r & root radius & cm \\ 
$light_{exp}$ & above-ground potential resource availability & gH2O.leaf area\\
$water_{exp}$ & below-ground potential resource availability & gH2O.root area\\
\end{tabular} 
%\end{center}
\vspace*{0.5cm}
\end{table*}

%little scheme to show what it looks like

\paragraph{Species} Plants are characterised by state variables that describe them individually, but they also share common characteristics with individuals of the same group, that we will refer as species in the rest of the document even-though it could be a group at an other scale. These species are the species present in the meta-population and that can invade the simulated ecosystem. There are described by multiple traits characterising the strategy of the species (table \ref{table:state_var_species}).


%TAble of plant state variables
\begin{table*}
\caption{Species traits}
\label{table:state_var_species}
\begin{center}
\begin{tabular}{l|c|c|l}
Trait & Range (close range) & unit & trade-of or strategy\\
\hline 
seed mass & (0.00001 - 0.001) & g & seed ouput vs seedling productivity\\
maturity & - & green biomass & flowering time vs reproduction potential\\
fract\_dev & 0-1 (0.05-0.6) & - & blooming vs persistence\\
fract\_rep & 0-1 (0-1) & - & reproduction vs persistence\\
geometric constant ($k_{g}$) & (0.1 - 20) & - & competition sensitivity vs self-shading\\
plasticity stability & 0-1  (0.8-1) & - & genetic information vs experience\\
initial water resource & (0.001 - 0.05) & $gH_{2}O.cm^{-2}$ & water resource niche\\
initial light resource & (0.001 - 0.05) & $gH_{2}O.cm^{-2}$ & light (in $H_{2}$ equivalent) resource niche\\
$\frac{act}{str}_{ag,d}$ & (0.03 - 0.3) & $g.g^{-1}$ & active vs structural tissue\\
$\frac{act}{str}_{gg,d}$ & (0.03 - 0.3) & $g.g^{-1}$ & active vs structural tissue\\
mean temp. & (0 - 5) & \celsius & early vs late germination\\
germination rate & 0-1 (0.5 - 1) & - & good season bet-hedging\\
thickness & 	(0.012 - 0.05) & cm & WUE vs light efficiency (not in this version)\\
\end{tabular} 
\end{center}
\vspace*{0.5cm}
\end{table*}
%table of species traits. trait, range, distribution, trade-of or strategy associated.

\paragraph{Seed-bank} The seed-bank is the transition state between the different seasons. Individuals may persist, but they can also reproduce by the production of new individuals. Lot of grasses use clonal reproduction, in addition or replacement of sexual reproduction. This type of reproduction is characterised by a persistent link between the newly produced individuals and the parent one that allow the two to communicate and exchange resources. Such dynamics are complex and costly to represent. To avoid too much complexity, it is possible to approximate the representation of clones to big seeds with little dispersion around the parent plant. For this reason, reproduction mechanism is reduce to sexual reproduction mechanism with production of "seeds". Seeds are stored in the seed-bank and only defined by their species and positions. 

\paragraph{Soil} Soil is an important aspect of the model as it drives (with the precipitations) the water competition between individuals. It is however limited, as in numerous vegetation models, to a grid characterised by: its capacity to retain water, and its depth. Only the first component (water retention capacity) is spatially variable and is described by the critical water content (minimum soil water content), the saturation water content (maximum water content, the water non absorbed leaves the system we assume the same root depth for all species), and the current water content (temporally variable, depending on competition, precipitation and evaporation, between the critical and the saturation water content) only dynamic variable among the three.

%table of soil state variables

\subsection{Process overview and scheduling}

As mentioned the model runs at daily step to capture individual responses to conditions and over multiple seasons to capture long temporal dynamics. Some processes occur (or are evaluated) at the daily time-step, some at the season time-step. The following ordered list presents the different processes and the scheduling over days and season of one simulation.\\
\indent One season can be divided in the following parts:
\begin{itemize}
\setlength\itemsep{0em}
\item \textit{germination}: marks the beginning of the season when the ground is no more snow covered. Seeds germinate into individual plants, based on species specific germination rate;
\item \textit{growing season}: consists in daily processes like competition, production of organic matter (OM), allocation, and death lottery;
\item \textit{reproduction-invasion-persistence}: marks the end of the season when the first persistent snow-fall occurs. OM invested in reproductive tissues turns into seeds that are sampled to create the seed-bank. Seeds from the meta-population may integrate the seed-bank. Persistent perennial individuals lose their aboveground biomass.
\end{itemize}

The \textit{growing season} part consists in all processes evaluated every day of the growing season. These processes are:
\begin{itemize}
\setlength\itemsep{0em}
\item \textit{resistance allocation}: the stored OM (in seeds or in storage tissues) are either invested in resistance molecules or in development;
\item \textit{freezing}: frost damage on plants;
\item \textit{light competition}: the individual potential photosynthetic activity is computed based on average daily light and shoot properties;
\item \textit{water competition}: evaporation and the individual water update (and potential water uptake) are computed based on potential transpiration, water availability and potential evaporation;
\item \textit{production}: respiration and production are computed to give the net productivity in OM;
\item \textit{senescence}: based on lifespan a part of tissue is no longer active.
\item \textit{death}: death of individuals based on their age and their desiccation stage (number of consecutive days with negative growth).
\item \textit{allocation}: allocation of produced OM to the 6 carbon pools of the plant.
\item \textit{grazing/cutting}: (optional) grazing or cutting of plants to a certain height. The grazing can be selective.
\end{itemize}

\section{Design concepts}

\subsection{Design concepts}
This part clarifies the rules that drives the dynamics of the model.

\paragraph{Emergence} The purpose of the model being to understand the rules that drive the community responses, we tried to make what define the community emerge from the underlying processes of plant growth, resource use and reproduction. That means that population dynamics is at least partially emergent from the surviving and reproducing individuals. It is partially emergent as it depends on the invasion rules applied to the system (see subsection \ref{text:invasion} for more details). The traits and biomass distribution that describe the community are completely emergent from the individual traits exposed by the individuals and their relative biomass.

\paragraph{Adaptation} Plants have in theory many options to adjust their phenotype and increase their fitness in response to cvhanges in environmental conditions (resource availability, temperature, ...). High diversity of mountain grasslands suggests that multiple strategies coexist and that individuals do not change to converge toward the best strategy. These strategies are set up at the species level by the species specific traits (see table \ref{table:state_var_species}). Therefore, individuals may only adapt morphological traits but not strategic traits (unless there is an epigenetic mechanism added). These morphological traits are: the relative biomass of shoot and root, relative proportion of active and structural tissues in each leaves, and roots (controlling respectivelly the SLA and SRL and the overall resource acquisition cost). We will ignore geometrics traits (distribution of leaves and roots within space) as grasses have far less control on their geometry than forbs or trees. Root distribution plasticity has been shown to greatly improve the individual and community productivity (Gemini aticle), but to keep the model (and implementation) simple we will ignore root distribution plasticity and foraging strategies to focus on allocation problems instead of spatial distribution questions.\\

\paragraph{Fitness} 
In the model the realised fitness can be estimated as the capacity of plants to maintain themselves or their descendants through time. It emerges from the productivity, allocation to storage or reproductive carbon pools, and survival. Assessing fitness as the average number of persistent individuals is however a bit hazardous in simulations limited in time and to a relatively small spatial scale. Plus, plants cannot easily make prediction of such variable to adjust their phenotype. They need a proxy function, integrating measures of external conditions to evaluate the best strategy to develop. As said above, this strategy should be a composite between the species strategy and individual adjustment specific to the individual experience of the environment. Plant fitness is estimated by individual plant thanks to a gain function integrating current phenotype, species strategy and projection of future conditions. This gain function can take multiple forms and be more or less constraint. In the context of the model, the function should include a measure of productivity that relies on the principle of functional equilibrium - that is the allocation of organic matter to maintain the balance between the shoot activity (transpiration) and root activity (water uptake). This equilibrium can be achieved by changes in shoot:root ratio only, or also changes in active over structural tissues ratio. Further details about the gain function are discussed in the dedicated paragraphs (\ref{par:allocation}). More complex form of functional equilibrium incorporating nutrients (like nitrogen) can easily be added to the framework of this model.

\paragraph{Prediction} Adaptation or plasticity mechanisms suggest that agents have an insight of what will be the future. In \model we consider that plants have two main sources of information. The first source of information is the genetic information. Indeed, the evolutionary process of genotype selection had led to the selection of genotypes adapted to the local conditions. This selection relationship can be seen as a link between environmental conditions and some genetic information. Because plants are not fully plastic, seeds from a particular environment will grow according to the particular genetic plan given into its genetic information that matches these conditions (this is supposed in all models with no phenotypic plasticity). This is an \textit{a priori} information about the external conditions. If the conditions where the seed grow change from the conditions its genotype has been selected for, the genetic information does not fit the environmental conditions. In this case, if the plant has a plasticity capacity, it can integrate the second source of information, in the form of the experienced conditions, to its "a priori" and forge a new estimation of what conditions will be. One question emerging to this idea is: how to balance the genetic \textit{a priori} information with the experienced information ? This balance can be described by a term of "reactivity" that describe the relative weight of genetic and experienced information. A reactive species will give a higher weight to experienced condition information, whereas an stable species will give a higher weight to genetic information.\\
\indent From that mechanism we can define a two terms: the \textbf{climatic niche center} of a species is the \textit{a priori} information on climatic conditions, and the \textbf{plastic capacity} of a species is both its reactivity and its capacity to overcome the plasticity cost and invest in required tissues.

%Individuals do not estimate directly their fitness. They have however way of estimating how well they perform depending on the level of resources they estimate. This measure is essential in plasticity mechanism as it drives plasticity. This measure is dependent on the plasticity mechanism chosen. Indeed plasticity can be approached in different ways that are discussed latter, one mechanism consists in maintaining the \textit{functional equilibrium}, in this case the fitness information is approach by the relative balance between above-and below-ground activities. The other mechanism is the \textit{optimisation}, that implies a more complex estimation of productivity, respiration, tissue turn-over and death changes and gives a more detailed approximation of individual fitness.

%\paragraph{Prediction and adaptation} As explained above, the "incomplete fitness proxies" used in the plasticity mechanisms require estimation of above- and below-ground activities, based on their trait values (SLA and SRL) and on an estimation of future external conditions (temperature, water availability and light availability). The originality of our approach is to make this estimation depending on both species specific parameters and individual experience. The conditions are estimated as the weighted mean between the species specific genetic \textit{a priori} on resource availability and the potential resource availability normalized over exchange area. This make the estimation by one individual depending both on the species specific "environmental niche" and the competition effects on resources. Moreover, this mechanism, because it includes relative weight to the two sources of information, allow multiple strategies for the estimation of external conditions and so on how to cope with resource levels variation.
%
%\paragraph{Adaptation} Adaptation is central in the model as we believe it explain a lot of intra-specific variability in mountain grassland ecosystems (cite albert and others)

\section{Details}

\subsection{Initialisation}
The model doesn't need particular initialisation if the state of the community species pool, the seedbank and the soil are given as inputs. Otherwise, a set of \textit{E(n/s)} individuals are created from a set of \textit{s} species (randomly generated if not given) and randomly positioned on the soil grid, where \textit{s} and \textit{n} are respectively the number of species and the approximate number of individuals within the grid. Soil grid is also randomly generated within default ranges for critical and saturation water contents then slightly smooth, and homogeneously filled ($ \frac{w_{cont} - w_{crit}}{w_{sat} - w_{crit}} = filling$).

\subsection{Inputs}
\model needs system state information (individuals, species, seed-bank and soil) and climate data. If the state of the system is not completely given, then the complete state is generated in the initialisation. The daily climate data at must contain the following fields:
\begin{itemize}
\setlength\itemsep{0em}
\item \textit{date};
\item \textit{radiance}, in $Watt.m^{2}$;
\item \textit{precipitation}, in mm;
\item \textit{mean temperature}, in K;
\item \textit{mean day temperature}, in K;
\item \textit{min temperature}, in K;
\item \textit{max temperature}, in K;
\item \textit{relative humidity} in \%;
\end{itemize}
Vapour pressure deficit is then computed from temperature and relative humidity.\\
\indent The climate data must explicitly differentiate the seasons (delimited by the first day of the year without snow and by the first day of the second semester with snow).

\subsection{Submodels}

\paragraph{Germination} Individuals from the seed-bank randomly germinate according to their species specific germination rate. Germination consist of investing 20\% of the seed mass into shoot and root biomass according to default traits (active on structural tissues ratios in shoot and root, shoot:root ratio). Non germinating seeds stay in the seed-bank.\\
%
%\vspace{0.5em}
%\paragraph{Freezing resistance allocation} Resistance mechanisms are important for plants to invade harsh environments with perturbations such as grazing of frost events. Investment in free organic compounds is shown to provide resistance to frost. The concentration of such compounds is time variable and closely related to temperature. Other mechanisms morphological, structural, physiological can also play a role in frost resistance. For the sake of simplicity we will limit this aspect to the investment in circulating agents. Moreover, this aspect is crucial, indeed  because the frost risk is high at the beginning of the season, the choice of investing in resistance molecules instead of growing tissues is a strategy choice. Species can then be differentiated on a earlier growing/high frost risk - late growing/low frost risk axis, depending on their estimation of minimal temperature. Minimal temperature is estimated the same way other resources levels. Available stored biomass is invested in frost resistance is the estimated mean temperature is below 3\celsius .\\
%
% 
%\paragraph{Freezing} The freezing damages are calculated based on the concentration of organic matter dedicated to frost resistance is the plant. The LT50 (temperature at which 50\% of biomass is lost) is proportional to the concentration of resistance molecules compare to overall biomass. Daily leaf biomass lost due to frost is computed as follow:
%
%
%\begin{align}
%k_{frost} &= log(1/dam_{-1} - 1)/(-1 - LT_{50})\\
%dam &= \frac{1}{1 + e^{k_{frost}(T_{min} - LT_{50})}}
%\end{align}

\textbf{Daily processes}\\

\paragraph{Light competition}Light competition is central in all vegetation model as it constraints the photosynthetic activity. To avoid costly calculation we assume vertical homogeneous radiation (it can be easily adapted to be heterogeneous). Relief and orientation effects have to be taken into account in the radiance data.\\
Light competition sub-model allows calculation of individual potential photosynthesis activity and light at soil surface for evaporation calculation.\\
Competition for light is calculated independently for each pixel, potential photosynthetic activity is then aggregated at the individual level. Each pixel can be seen as a column of homogeneous layers containing at least one individual (top layer). For each layer the light transmission is computed based on leaf density.


\begin{marginfigure}
\begin{tikzpicture}
\begin{axis}[marginplot,
legend style
={at={(1, 1.1)},
anchor=south east,
draw = none},
samples = 40,
%restrict y to domain=-300:700,
ylabel = $I_{h}$,
xlabel = $h$
%extra x ticks={0.618},
%extra x tick style={grid=major}
]

\addplot[orange][domain = 0:10 ] {120 * exp(-1*x)};
%\addplot[gray][domain = 0:1 ] {(1/(0.022 * 1)) * ((1/0.05 - 1)*x) - %(7*exp(7*x) + 0.03)};
%\legend{$I_{h}$}
\end{axis}
\end{tikzpicture}
\label{fig:derivaives}
\caption{Net gain function and its first derivative.} Looks like there is some kind of mismatch here.
\end{marginfigure}

\begin{equation}\label{eq:Ih}
I_{h} =  I_{0} e^{-LAI_{h}}
\end{equation}

where $LAI_{h}$ is the cumulative LAI at the bottom of layer \textit{l} (between $h$ and $h+\Delta_{h}$) defined as the homogeneous layer delimited by the top of consecutive individuals in the same pixel. The LAI is calculated like this:
\begin{equation}\label{eq:LAI}
LAI_{h} = LAI_{h+\Delta_{h}} +  \Delta h_{l, l-1} . pix\_width^{2} \sum_{i\ in\ l}d_{i}.coverage_{i, p}
\end{equation}
where $d_{i}$ is the individual leaf area density corrected by the coverage ($0< coverage =< 1$) of the pixel by the plant, $\Delta_{h}$ is the height of the layer.\\
Following Thornley and Johnson, the potential photosynthetic leaf activity is calculated as :


\begin{marginfigure}
\begin{tikzpicture}
\begin{axis}[marginplot,
legend style
={at={(1, 1.1)},
anchor=south east,
draw = none},
samples = 100,
%restrict y to domain=-300:700,
xlabel = $I$,
ylabel = $P_{leaf}$
%extra x ticks={0.618},
%extra x tick style={grid=major}
]

\addplot[orange][domain = 0:0.00001 ] {(\paralpha * x * \parPmax ) /(\paralpha * x + \parPmax ) };
\legend{}
\end{axis}
\end{tikzpicture}
\label{fig:derivaives}
\caption{Photosynthetic saturation function}
\end{marginfigure}

\begin{equation}\label{eq:Pleaf}
P_{leaf} = \frac{\alpha. I_{leaf}.Pm_{i}}{\alpha I_{leaf}+Pm_{i}}
\end{equation}
 where $I_{leaf}$ is the light absorbed by the leaf and the photosynthetic potential rate $Pm_{i}$ is linearly related to active biomass per leaf area as follow:
\begin{equation}
Pm_{i} = min(P_{slope} \frac{Leaf_{Act_{i}}}{Area_{i}}, P_{max})
\end{equation}
where $\alpha$ is the initial slope of the light response curve and $Pm_{i}$ is the maximum gross photosynthetic rate, $I_{leaf}$ is the radiance at the leaf surface, derived by correcting the radiance at the top of the layer :

\begin{equation}
I{leaf}(h) = \frac{k}{1-m}I_{h}
\end{equation}

The equation \eqref{eq:Pleaf} can be integrated over the leaf surface by mixing it with equations \eqref{eq:Ih} and \eqref{eq:LAI}:
\begin{equation}\label{Ppixlay}
\int_{h_{bottom}}^{h_{top}}P_{leaf}(p,l) = d_{i}.coverage_{i}.\Delta_{h}\int_{h_{bottom}}^{h_{top}}P_{h}
\end{equation}
%
%\begin{equation}
%P_{leaf}(l) = \int_{h_{l-1}}^{h_{l}}P_{leaf}.dLeaf = Leaf_{area}\left[- Pm_{leaf}.log(|m.Pm_{leaf} - Pm_{leaf} - \alpha.I_{h(leaf)}|)\right]_{h_{l}}^{h_{l-1}}
%\end{equation}

the total leaf potential photosynthesis is then calculated as follow:
\begin{equation}\label{eq:PS_pot}
PS_{pot} = \sum_{p\ in\ shoot}\sum_{l\ in\ pixel}\int_{h_{bottom}}^{h_{top}}P_{leaf}(p,l)
\end{equation}
\indent Potential photosynthesis must then be converted to potential transpiration to define the water demand. The conversion from photosynthesis to transpiration is done by dividing the potential photosynthesis by the WUE (see subsection \ref{subsection:WUE} for more details). The potential activity of leaves are also dependent on the regulation of stomata so the transpiration can be written:
\begin{equation}
transp = \frac{PS_{pot} . g_{red}}{WUE}
\end{equation}

\paragraph{Stomatal regulation} Photosynthesis depends on gazes exchanges at the leaf surface. These fluxes result from relative concentration in carbon dioxide and water, and from the stomatal conductance. Stomatal conductance is reduced and limits productivity when vapour pressure deficit is too high. A linear relationship describe this relationship:
\begin{equation}
g_{red} = 1+ VPD_{g\_red}
\end{equation}

\paragraph{Evaporation} Potential evaporation is calculated for each pixel depending on the light at soil surface:

\begin{align}
 \beta &= 0.25 * (1 - cos( water_{cont}/water_{sat} * \pi))^{2}) & if water_{cont} \le water_{sat}\\
 \beta &= 1 & otherwise\\
 PET &= 0.0023. \sqrt{(T_{max} - T_{min})} * (T_{mean} + 17.8)\\
 evap &= PET . \beta . I_{surface} . daylength
\end{align}

\paragraph{Water competition} Water competition is also computed at the pixel level. To determine the water uptake, we first calculate the individual water demand as the minimum between the transpiration and the potential water uptake. Transpiration is easily calculated by dividing the potential photosynthetic activity by the water use efficiency, and is then normalized by the volume in the pixel over the overall root volume. Water potential uptake is the product of root area and root water uptake rate, leading to the water demand for individual $i$:
\begin{align}
transp_{i} &= frac{P_{i}}{WUE_{i}}\\
Wpot_{i} &= Root_{area}.Coverage_{i}.U_{i}\\
Wdem_{i} &= min(transp_{i}, Wpot_{i})\\
\end{align}
Where $U_{i}$ is related to the maximum water uptake $U_{max}$ and to the the $\frac{Root_{Act_{i}}}{Area_{i}}$  as in equation \eqref{eq:Pleaf}.\\
The total water demand per pixel is then the sum of all water demand of the pixel and potential evaporation. For each individual in the pixel, the realised water uptake is the individual water demand multiplied by the soil water availability reduction coefficient ($U_{lim}$). Is the total water demand exceeds the total water availability ($W_{av}$) then the available water is distributed proportionally to the individual demand.\\
\begin{equation}\label{eq:water_uptake}
Wup_{i} = Wdem_{i} . U_{lim} . \frac{Wdem_{total}}{min(Wdem_{total}, W_{av})}
\end{equation}
where:
\begin{align}
U_{lim} &= exp\left(\beta_{\theta} \left( \frac{1}{\theta_{s} - \theta_{crit}} - \frac{1}{\theta - \theta_{crit}}\right)\right) & if \theta < \theta_{crit}\\
 &= 0 & otherwise
\end{align}
\indent The potential water uptake, non limited by the transpiration is calculated the same way but considering $Wdem_{i} = Wpot_{i}$ in equation (\ref{eq:water_uptake}).


\paragraph{Condition estimation} External conditions are estimated based on \textit{a priori} information and experience. The first estimation is the genetic memory, the species specific values for initial light and water availability. The estimation is then updated with perception of resource availability weighted by $(1- \tau)$. Experienced conditions are estimated as the potential activity of above- and below-ground organs. The potential transpiration and the potential water uptake are normalized to the exchange area of respectively leaves and roots, defining the resource availability experienced. 
\begin{align}
light_{exp} &= \frac{transp}{SLA . BM_{ag}.g_{red}}\\
water_{exp} &= \frac{Wup}{SRL . BM_{bg}}\\
\end{align}
leading to:
\begin{align}
light_{est} &= (1 - \tau).light_{exp} + \tau . light_{est}\\
water_{est} &= (1 - \tau).water_{exp} + \tau . water_{est}
\end{align}
\indent Because these are supposed to be expected conditions for the future, other formulation can be used instead of an average that is likely to introduce a lag in estimations.

\paragraph{Production, and respiration} Following previous vegetation models, the respiration is decomposed in growth respiration and maintenance respiration. The first is function of trait values, biomass and temperature:
\begin{equation}
R_{m} = \left(R_{act}.\left(Act_{ag} + Act_{bg}\right)\right) . daylength . T_{effect}
\end{equation}
where $R_{act}$ is the respiration rate of active tissues and $Act_{ag}$ and $Act_{bg}$ are the active biomass pools in shoot and root.\\
\indent Net Primary production (in $CO_{2}$ equivalent) can then be calculated the difference of GPP and respiration, then converted in OM production thanks to tissue carbon content (under the assumption of fixed carbon content for leaf and roots between species):
 \begin{align}
 NPP_{carbon} &= (1- R_{g}) . (WUE . min(w_up, trans_p) - R_{m})\\
 NPP_{OM} &= NPP_{carbon} . (12/44) / TCC
\end{align} 


\paragraph{Temperature effect} Temperature has a effect of plant activity, this effect can be modelled by a bell shape function around an optimum value of 20 \celsius . See Lohier for details.


\paragraph{Senescence}

Senescence is the process of aging of tissues. This process uselly occurs at the scale of an individual organ (e.g. a leaf), however \model does not consider organs independently because it would be complex and computationally expensive to follow multiple leaves and roots for all individuals. So the process is considered homogeneous over all tissues. The fraction of senescent tissue is calculated based on the tissues lifespan, giving :
\begin{align}
sen_{leaf} &= \frac{1}{LLS}\\
sen_{root} &= \frac{1}{RLS}
\end{align}
where $LLS$ and $RLS$ are respectively the leaf and the root lifespans calculated as negative log-linear relationships with SLA and SRL.\\
\indent Root senescent tissues disappear from the system. Information about senescent biomass is stored, but senescent biomass effect of light competition is ignored in this version because as it is implemented senescent tissues appear early in plant development and have large negative effect on light absorption.\\
! it does not happen in the same time.

\paragraph{Death} Death is modelled as in Reineking 2006. Age and desication (negative NPP) are the two reasons why a plant can die. The two mechanisms are simulated by random draw and comparaison to the following probability function:
\begin{align}
P_{d} &=  exp \left( - \left[\left(\frac{des}{\alpha_{d}}\right)^{\gamma_{d}} - \left(\frac{max(des - 1, 0)}{\alpha_{d}}\right)^{\gamma_{d}}\right]\right) & if NPP \le 0\\
&= 1 & otherwise\\
P_{a} &= exp \left( - \left[\left(\frac{age + 1}{\alpha_{a}}\right)^{\gamma_{a}} - \left(\frac{age}{\alpha_{a}}\right)^{\gamma_{a}}\right]\right)\\
\end{align}

\paragraph{Allocation} \label{par:allocation}
Allocation is primordial in plant development and we must be careful when modelling it. We can distinguish two phases in plant development that impact a lot OM allocation: the vegetative phase, and the reproductive phases. The separation between these phases and the development allocation are discussed in the following paragraphs.\\

\textbf{Maturity:} Plants are considered mature in \model when the phenologic variable has reach a species specific threshold. The phenologic variable can be either the age, the height, the biomass, degree.days, in the current version age is used.\\
\indent 

\textbf{Allocation to stem:} Even-though grasses do not grow high vegetative parts like trees, some grow vertically and they are exposed to stronger winds than most of forest, and therefore need structural supports. Not all grasses grow stem, so we suppose that the supporting function is fulfilled by the leaf structural tissue. The minimal mechanical support needed is calculated as a function of above-ground biomass:
\begin{equation}
support = \alpha_{L} . (BM_{ag})^\gamma_{L}
\end{equation}
where $\alpha_{L}$ and $\gamma_{L}$ are the shoot allometry and shoot allometry exponent.\\
\indent To avoid complex allocation optimisation problem, the allocation of supporting tissue is done before any other allocation. Is the support is not sufficient, no organic matter can be invested in vegetative development. The biomass the plant needs to invest in the stem is defined as:
\begin{equation}
\Delta_{stem} = max(support - (stem + Str_{ag}), 0)
\end{equation}
where $Str_{ag}$ is the structural biomass in shoot.\\

\indent Allocation of produced organic matter is central in vegetation as it shapes the plant and define the strength of the different organs. There are multiple ways to model the distribution of produced organic matter between the plant organs. We believe that such mechanism has great impact on individual development and response to external conditions, and so on community dynamics. To explore the role of this mechanism, multiple options are implemented. The different allocation algorithms are summarised in the following table:


%TAble of plant state variables
\begin{table*}
\caption{Allocation algorithms implemented in \model} 
\label{table:state_var_plant}
%\begin{center}%
\begin{tabular}{l|c|c c c}
Algorithm & Objective & variable RSR & variable SLA-SRL & stochastic \\ 
\hline 
Fixed & $-$ & $\circ$ & $\circ$ & $\circ$ \\
Equilibrium & functional eq. & $\bullet$ & $\bullet$ & $\bullet$ \\
Eq-F & functional eq. & $\bullet$ & $\circ$ & $\bullet$ \\
Optimisation & instantaneous gain & $\bullet$ & $\bullet$ & $\bullet$ \\
Optim-F & instantaneous gain & $\bullet$ & $\circ$ & $\bullet$ \\
\end{tabular} 
%\end{center}
\vspace*{0.5cm}
\end{table*}

\textbf{Fixed trait allocation:} The fixed allocation supposes the allocation on OM to maintain trait values to fixed species specific values. The shoot:root ratio may however change to maintain functional equilibrium. The shoot root ratio is derived from the following equation of the functional equilibrium:
\begin{align}\label{eq:equilibrium}
SLA . BM_{ag} . light_{est} &= SRL . BM_{bg} . water_{est}\\
\frac{BM_{ab}}{BM_{bg}} &= \frac{SRL}{SLA} . \frac{water_{est}}{light_{est}}
\end{align}
where $light_{est}$ and $water_{est}$ are the estimated resource availabilities.
%
%\subparagraph{Plastic functional equilibrium} This allocation mechanism is also based on the functional equilibrium, however it incorporate changes in traits, that means that the proportion between active and structural tissues in an organ can change. This idea is supported by tha fact that plants change both their shoot:root and their trait values when conditions change. From a perspective with only one allocation dimension (shoot or root in "fixed trait allocation") with three dimensions (shoot or root, active or structural in shoot and in root tissues), the number of constraints must increase to find a unique solution. The functional equilibrium only is not sufficient to define the allocation scheme as multiple solutions satisfy this constraint. The solution is to chose among all possible allocation schemes the closest to the current allocation, the shortest path to functional equilibrium. This is done by minimising the 
% doesn't work for now

\textbf{Pseudo-optimization:} Another approach to allocation is to try to optimize it based on a fitness proxy. This proxy can  be the sum of NPP, tissue turn-over loss and plasticity cost. The individual performance is calculated as:
\begin{equation}
Perf = NPP_{f} + TO_{f} + Stem_{f} + survival_{f}
\end{equation}
where $NNP_{f}$ is the projected NPP based on the estimated activity of shoot and root, and estimated temperature, $TO_{f}$ is the biomass lost due to turn-over, $Stem_{f}$ is the biomass needed in the stem and that will not be invested is the active tissues and $survival_{f}$ is the total biomass multiplied by the estimated survival chances.\\
\indent Having a performance function is not sufficient to find the best allocation scheme, and a research algorithm must be used. To avoid the very costly use of R internal optimisation function, a pseudo gradient approach is used. This approach estimates the performance of allocation to the four carbon pools (active tissue in shoot, structural tissue in shoot, active tissue in root and structural tissue in root) for 5 allocation schemes: full allocation to one of the pools and balanced allocation to all pools. Then investment in the different pools is calculated as the sum of relative performances multiply by allocation schemes. This algorithm is however weak and must be redesigned.

\textbf{Plastic trait equilibrium:} Another approach can be easily derived from the previous one and extend the principle of the first: the functional equilibrium with plastic traits. This approach consists in using the same algorithm as pseudo-optimisation mechanism but measure performance with a function negatively related to the difference between estimated shoot and root activity. Such mechanism would nonetheless require the algorithm to look for close solutions within the allocation space to avoid convergence or drift from species strategy.


\textbf{Trait update:}
Plasticity in trait suggests that trait values are modified in time. Because plants are described by single values (e.g. one SLA value for all leaves), this values must be updated after the plastic allocation. This values could be updated as average of old tissue value weighted by old biomass and new tissue value weighted by the freshly produced biomass. This however would work only if active on structural tissues ratio were linearly link to others traits. This is not the case, it is then simpler to consider that organs have uniform active and structural distribution. This hypothesis suggests that whenever the allocation scheme change, old tissue reallocate their own biomass to follow the new scheme. Nevertheless, to avoid full plasticity allowed by this hypothesis, the changes in trait carbon pool sizes is limited by the produced biomass available for plant development.\\
\indent From this, supposing homogeneous distribution of active and structural tissues within an organ allow to directly link the size of the carbon pools to average traits by the following relationships:

\begin{align}
  th_{a} &= \frac{\frac{act}{str}_{s} . th . \rho_{ss}}{\rho_{as} + \frac{act}{str}_{s} . \rho_{ss} }\\
  SLA &= \frac{1}{(th_{a} . \rho_{as} + (th - th_{a}) . \rho_{ss} ) . V_{t}}\\ 
  s_{a} &= \frac{\frac{act}{str}_{r} . s_{root} . \rho_{sr} }{ \rho_{ar} + \frac{act}{str}_{r} . \rho_{sr}}\\
  SRL &= \frac{1}{(s_{a} . \rho_{ar} + (s_{root} - s_{a}) . \rho_{sr}}
\end{align}



\paragraph{Reproduction \& persistence}
\textbf{Sexual \& clonal reproduction:} reproduction is handled at the end of the season. To limit the number of parameters reproduction is limited to the division of the invested biomass in reproduction by the species specific seed biomass into a round number of seeds (the number of seed per plant could also be a differentiation axis). Clonal reproduction is not explicitly represented but can be mimic with bigger seeds and by adding a dispersion process around the parents. The seeds then are added to a potential seed-bank. This potential seed-bank is sampled, after eventual invasion, and merged with the existing seed-bank.\\
\indent Control on the sampling process allows to model different type of ecosystems and test different hypothesis on invasions impact on community dynamics. The link between the community and the meta-community can also be explored through seed-bank control.\\
\indent Three types of invasion/reproduction are currently implemented:
\begin{itemize}
\item closed environment reproduction: the seeds produced in the community return to the community, no invasion, the seed-bank size can be limited by a seed density limiting calculation explosions and simulating density mortality. Such mechanism should in theory lead to low diversity unless close equivalence between some species;
\item constant reproduction in open environment: the seed-bank is generated at the meta-population levels, all species have the same biomass invested in reproductive pool independently from the local performance and seeds are randomly sampled. This mechanism stabilize greatly the system by does not allow to explore the meta-community dynamics and selection processes;
\item productivity dependent reproduction in open environment: this mechanism is similar to the previous system but incorporate the productivity of the system by defining the seed input biomass as the total invested biomass in reproduction in the system at the end of the season. System is stabilize but the overall productivity impacts the seed-bank dynamic.
\end{itemize}

\textbf{Persistence} Some grasses are perennial and persist over the cold season. This is allowed in the model by investment in storage tissues instead of reproductive tissues. This mechanism allows the plant to benefit from the same conditions and to maintain below-ground biomass. At the end of the season, market by the snow cover, these plants (with non-null storage biomass) loss most of their above-ground biomass.

\paragraph{Grazing/cutting} Explore management effect on the community is one of the aim of the \model model. The management of mountain grassland will be explore only of the aspect of biomass removal, as productivity changes can be explore by changing the parameters value as the nutrients are not explicitly modelled. The management sub-model is not detailed here but it is based on the mapping of biomass and target trait (e.g. fraction of structural biomass as proxy for digestibility). Both cutting and grazing can be modelled but require management plan in the form of calendar of management operation and a cutting height or harvest objective.\\

\section{Limitations and problems}

\subsection{Link to the real world and data}
The generalized framework introduced in \model allows to create a rich community in a high number of dimension strategy space, it however comes with downsides.\\
\indent One of the first problem is that some parameters (not explicitly detailed here) are hard to access (e.g. tissue density of active, or structural, tissue). It makes the calibration long as the incertitude for some parameters is very high. This is problematic when calibration is made difficult by a large execution time (see subsection below).\\
\indent Another issue with such model is that the high dimensionality of the species strategy space allows a lot of different strategies that are not viable. This could be overcome by selection mechanism over multiple plots, but again require a lot of simulation. Moreover, there are dependencies between viable strategies and parameter values that makes it hard to restrict meta-community to viable species to set-up calibration runs.\\
\indent It is possible to extract summary statistics from the model output and compare them to information from collected data making calibration and community analysis easy. However going from the data to feed the model is harder, indeed without a great knowledge of a species it is hard to define its representation within the model framework. To do so would require the knowledge of the plasticity capacity to set the reactivity, anatomical traits to define default ratios of active over structural tissues, and climatic niche to define the \textit{a priori} estimation of external conditions. Without making direct association with real species, it is possible and interesting to try to reproduce some strategies and explore their response to various conditions.

\subsection{Technical problems}

The model is implemented in R with some limiting function using RCPP to speed up the process. Simulations are fairly slow compare to theoretical CPP equivalent code. The main problem is in the choice of the data structure. Indeed agents are stored in data.frames that are often modified with the \verb|mutate| function, that makes the implementation much easier and the code readable, but slow down the execution due to constant condition checking on operations. This makes calibration routine methods almost impossible to use as they demand a very number of runs to be efficient.\\
\indent The slowness of the model also limit to simple algorithms for the research of favourable positions in the allocation space.
%
%\subsection{Conceptual framework}
%
%Based on requirements listed above, I built a conceptual framework based on strategic differentiation along functional trade-off and phenotypic plasticity driven by functional equilibrium.
%
%\paragraph{Strategic differentiation, trade-offs and carbon pools}
%Functional trade-off 
%
% \begin{table}[h]
% \caption{Alternative ways to model plastic allocation in IBM}\label{plasticity_options}
% \begin{center}
% \begin{small}
%\begin{tabular}{lllc}
%\toprule
%Method & Pros & Cons & Ref\\ 
%\midrule
%\multirow{2}{*}{\textbf{Stress response}} & simple & specific parameters & \multirow{3}{*}{Scheiter and Higgins}\\
%& multiple drivers/stress & & \\
%\midrule
%\multirow{3}{*}{\textbf{Optimization function}} & optimization of fitness & fitness proxy & \multirow{3}{*}{McMurtie}\\
%& multiple drivers & computationally expensive & \\
%&  & risk of convergence & \\
%\midrule
%\multirow{2}{*}{\textbf{Functional equilibrium}} & multiple strategies & limited number of drivers & \multirow{2}{*}{Lohier}\\
%& leaves/roots coordination & computationally expensive & \\
%\bottomrule
%\end{tabular}
% \end{small}
% \end{center}
% \begin{captiontable}
% \end{captiontable} 
% \label{table:plasticity}
% \end{table}

% 
%\begin{figure*}
%\begin{center}
%\includegraphics[width=12cm]{figures/plasticity_drivers.pdf}
%\end{center}
% \caption{Plasticity drivers modelling options.}
%\label{fig:plasticity}
%\footnotesize{Three possible options of how to drive phenotypic plasticity of carbon allocation are represented. One individual of species A and  B are represented, they have different life history, strategies and traits values by have the same perception of their environment. A.Stress response. The allocation paths follow the stress direction without species specific scheme. In this case the stress is the same for both individuals but we can imagine that the perception of stress can be tuned by species specific parameters. B. Optimization function. The allocation and trais values are determine by an optimization function. Each individual tries to reach the center of the valley maximizing the fitness proxy but there are contained in local strategy space by cost of plasticity. C. Functional equilibrium. The allocation is drive nby the criterion of equilibrium between above and below-ground activities. Individuals have the same co-limitation crest and will try to reach it by the shortest path.}
%\end{figure*}



 \nocite{TitlesOn}
 \bibliographystyle{cell}
 \bibliography{biblio_model_description}

\end{document}